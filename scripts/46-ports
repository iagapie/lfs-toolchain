name=ports
version=1.6
source=(https://crux.nu/files/tools/ports/ports-$version.tar.gz)

build() {
	cd $name-$version

	make
	make BINDIR=/tools/bin ETCDIR=/tools/etc/ports PORTSDIR=/tools/etc/ports MANDIR=/tools/share/man install
	sed 's,etc/ports,tools/etc/ports,g' -i /tools/bin/ports

    mkdir -pv /tools/etc/ports/drivers

    cat > /tools/etc/ports/drivers/httpup << "EOF"
#!/bin/sh
#
# /etc/ports/drivers/httpup: httpup driver script for ports(8)
# 

if [ $# -ne 1 ]; then
        echo "usage: $0 <file>" >&2
        exit 1
fi

. $1

if [ -z "$ROOT_DIR" ]; then
	echo "ROOT_DIR not set in '$1'" >&2
	exit 2
fi
if [ -z "$URL" ]; then
	echo "URL not set in '$1'" >&2
	exit 2
fi

for REPO in $URL; do
    PORT=`echo $REPO | sed -n '/#.*$/s|^.*#||p'`
    httpup sync $REPO $ROOT_DIR/$PORT
done

# End of file.
EOF
    
    chmod 755 /tools/etc/ports/drivers/httpup

cat > /tools/etc/ports/core.httpup << "EOF"
#
# /etc/ports/core.httpup: core's port collection
#

ROOT_DIR=/usr/ports/core
URL=https://raw.githubusercontent.com/iagapie/lfs-ports/master/core/

# End of file
EOF

cat > /tools/etc/ports/extra.httpup << "EOF"
#
# /etc/ports/extra.httpup: extra's port collection
#

ROOT_DIR=/usr/ports/extra
URL=https://raw.githubusercontent.com/iagapie/lfs-ports/master/extra/

# End of file
EOF

cat > /tools/etc/ports/xorg.httpup << "EOF"
#
# /etc/ports/xorg.httpup: xorg's port collection
#

ROOT_DIR=/usr/ports/xorg
URL=https://raw.githubusercontent.com/iagapie/lfs-ports/master/xorg/

# End of file
EOF

cat > /tools/etc/ports/gnome.httpup << "EOF"
#
# /etc/ports/gnome.httpup: gnome's port collection
#

ROOT_DIR=/usr/ports/gnome
URL=https://raw.githubusercontent.com/iagapie/lfs-ports/master/gnome/

# End of file
EOF

    chmod 644 /tools/etc/ports/{core,extra,xorg,gnome}.httpup
}